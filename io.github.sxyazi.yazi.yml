id: io.github.sxyazi.yazi
runtime: org.freedesktop.Platform
runtime-version: &runtime-version '25.08'
sdk: org.freedesktop.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.rust-stable
  - org.freedesktop.Sdk.Extension.golang
command: yazi-wrapper.sh
add-extensions:
  # Needs ffmpeg to generate video preview thumbnails
  org.freedesktop.Platform.ffmpeg-full:
    directory: lib/ffmpeg
    add-ld-path: .
    version: *runtime-version
    no-autodownload: false
    autodelete: true

finish-args:
  # File manager needs access to every file
  - --filesystem=host

build-options:
  append-path: /usr/lib/sdk/rust-stable/bin

modules:
  # For downloading themes/plugins with the `ya` package manager
  - name: git
    make-args:
      - INSTALL_SYMLINKS=1
    make-install-args:
      - INSTALL_SYMLINKS=1
    cleanup:
      - /lib/pkgconfig
      - /man
      - /share/git-gui
    sources:
      - type: archive
        url: https://www.kernel.org/pub/software/scm/git/git-2.52.0.tar.xz
        sha256: 3cd8fee86f69a949cb610fee8cd9264e6873d07fa58411f6060b3d62729ed7c5
        x-checker-data:
          type: anitya
          project-id: 5350
          stable-only: true
          url-template: https://www.kernel.org/pub/software/scm/git/git-$version.tar.xz
  # For formatted json previews
  - name: jq
    config-opts:
      - --disable-maintainer-mode
      - --disable-docs
      - --disable-valgrind
      - --with-oniguruma=builtin
    sources:
      - type: git
        url: https://github.com/stedolan/jq
        tag: jq-1.8.1
        commit: 4467af7068b1bcd7f882defff6e7ea674c5357f4
        x-checker-data:
          type: anitya
          project-id: 13252
          stable-only: true
          tag-template: jq-$version
      - type: script
        commands: [autoreconf -if]
        dest-filename: autogen.sh
    cleanup:
      - /bin/onig-config
      - /share/doc
      - /include
  # For generating image preview thumbnails
  - name: imagemagick
    config-opts:
      - --disable-static
    sources:
      - type: git
        url: https://github.com/ImageMagick/ImageMagick.git
        tag: 7.1.2-12
        commit: bdd4fa561d7bf4c6afd40ee9c89e9f9e82b6e88b
        x-checker-data:
          type: anitya
          project-id: 1372
          stable-only: true
          tag-template: $version
    cleanup:
      - /share/doc
      - /include
  # fuzzy finder
  - name: fzf
    buildsystem: simple
    build-options:
      append-path: /usr/lib/sdk/golang/bin
    build-commands:
      - make
      # the file name is arch-dependent, so use wildcard instead
      - install -Dm00755 target/fzf* /app/bin/fzf
    sources:
      - type: git
        url: https://github.com/junegunn/fzf.git
        tag: v0.67.0
        commit: 2ab923f3ae04d5e915e5ff4a9cd3bd515bfd1ea5
        x-checker-data:
          type: anitya
          project-id: 15856
          stable-only: true
          tag-template: v$version
      # Workaround for Go modules generated by github.com/dennwc/flatpak-go-mod
      - modules/fzf/sources.yml
  # Recursively searching for files in the current directory using a regex
  - name: ripgrep
    buildsystem: simple
    build-options:
      env:
        - CARGO_HOME=/run/build/ripgrep/cargo
    build-commands:
      - cargo --offline fetch --manifest-path Cargo.toml
      - cargo --offline build --release
      - install -Dm00755 target/release/rg /app/bin/rg
    sources:
      - type: git
        url: https://github.com/BurntSushi/ripgrep.git
        tag: 15.1.0
        commit: af60c2de9d85e7f3d81c78601669468cf02dabab
        x-checker-data:
          type: anitya
          project-id: 15461
          stable-only: true
          tag-template: $version
      - modules/ripgrep/cargo-sources.json
  # Alternative of find.
  - name: fd
    buildsystem: simple
    build-options:
      env:
        - CARGO_HOME=/run/build/fd/cargo
    build-commands:
      - cargo --offline fetch --manifest-path Cargo.toml
      - cargo --offline build --release
      - install -Dm00755 target/release/fd /app/bin/fd
    sources:
      - type: git
        url: https://github.com/sharkdp/fd.git
        tag: v10.3.0
        commit: d38148f0aabdd073b4080cde770f679f3197b920
        x-checker-data:
          type: anitya
          project-id: 373722
          stable-only: true
          tag-template: v$version
      - modules/fd/cargo-sources.json
  # For quickly jumping to another directory
  - name: zoxide
    buildsystem: simple
    build-options:
      env:
        - CARGO_HOME=/run/build/zoxide/cargo
    build-commands:
      - cargo --offline fetch --manifest-path Cargo.toml
      - cargo --offline build --release
      - install -Dm00755 target/release/zoxide /app/bin/zoxide
    sources:
      - type: git
        url: https://github.com/ajeetdsouza/zoxide.git
        tag: v0.9.8
        commit: 859268aec873465b6707f73001003a76adcafabd
        x-checker-data:
          type: anitya
          project-id: 98400
          stable-only: true
          tag-template: v$version
      - modules/zoxide/cargo-sources.json
  # For svg previews
  - name: resvg
    buildsystem: simple
    build-options:
      env:
        - CARGO_HOME=/run/build/resvg/cargo
    build-commands:
      - cargo --offline fetch --manifest-path Cargo.toml
      - cargo --offline build --release
      - install -Dm00755 target/release/resvg /app/bin/resvg
    sources:
      - type: git
        url: https://github.com/linebender/resvg.git
        tag: v0.45.1
        x-checker-data:
          type: anitya
          project-id: 377646
          stable-only: true
          tag-template: v$version
        commit: 1b6c2fddbcbeffa8135df4323b02aaae84890907
      - modules/resvg/cargo-sources.json
  # For spawning processes outside the flatpak sandbox
  - name: host-spawn
    buildsystem: simple
    build-options:
      append-path: /usr/lib/sdk/golang/bin
    build-commands:
      - ./build.sh $FLATPAK_ARCH
      # the file name is arch-dependent, so use wildcard instead
      - install -Dm00755 build/host-spawn-$FLATPAK_ARCH /app/bin/host-spawn
    sources:
      - type: git
        url: https://github.com/1player/host-spawn.git
        tag: v1.6.2
        commit: d76c3a5196a8e0943f6a1c7c9f1acde4bd83c40c
        x-checker-data:
          type: anitya
          project-id: 270202
          stable-only: true
          tag-template: v$version
      # Workaround for Go modules generated by github.com/dennwc/flatpak-go-mod
      - modules/host-spawn/sources.yml
  # For previewing the content of a zip file
  - name: p7zip
    make-args:
      - 7z
    no-autogen: true
    make-install-args:
      - DEST_HOME=/app
    sources:
      - type: archive
        url: https://github.com/p7zip-project/p7zip/archive/refs/tags/v17.05.tar.gz
        sha256: d2788f892571058c08d27095c22154579dfefb807ebe357d145ab2ddddefb1a6
        x-checker-data:
          type: json
          url: https://api.github.com/repos/p7zip-project/p7zip/releases/latest
          url-query: '"https://github.com/p7zip-project/p7zip/archive/refs/tags/\($version).tar.gz"'
          version-query: .tag_name
    cleanup:
      - /share/doc
      - /man
  # For pdf previews
  - name: poppler
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DCMAKE_BUILD_TYPE=Release
      - -DBUILD_GTK_TESTS=OFF
      - -DBUILD_QT5_TESTS=OFF
      - -DBUILD_QT6_TESTS=OFF
      - -DBUILD_CPP_TESTS=OFF
      - -DENABLE_CPP=ON
      - -DENABLE_GLIB=OFF
      - -DENABLE_QT5=OFF
      - -DENABLE_QT6=OFF
      - -DENABLE_BOOST=OFF
    sources:
      - type: archive
        url: https://poppler.freedesktop.org/poppler-25.12.0.tar.xz
        sha256: c18b40eb36b1a0c5b86e29ca054bf0770304583da4f2cdd42fe86eca6a20de48
        x-checker-data:
          type: anitya
          project-id: 3686
          stable-only: true
          url-template: https://poppler.freedesktop.org/poppler-$version.tar.xz
  # Main module
  - name: yazi
    buildsystem: simple
    build-options:
      env:
        - CARGO_HOME=/run/build/yazi/cargo
    build-commands:
      - cargo --offline fetch --manifest-path Cargo.toml
      - cargo --offline build --release
      - mkdir -p /app/lib/ffmpeg
      - install -Dm00755 target/release/yazi ${FLATPAK_DEST}/bin/yazi
      # `ya` is a package manager for themes/plugins
      - install -Dm00755 target/release/ya ${FLATPAK_DEST}/bin/ya
      # Upstream icon is 1254x1260. Shrink to 512x512 to conform to icon standard. 
      - ffmpeg -hide_banner -i assets/logo.png -vf scale=512:512 logo.png
      - install -Dm00644 logo.png ${FLATPAK_DEST}/share/icons/hicolor/512x512/apps/${FLATPAK_ID}.png
      # The icon specified in the upstream dot desktop file does not play nicely with Flatpak.
      - desktop-file-edit assets/yazi.desktop --set-key=Icon --set-value="${FLATPAK_ID}"
      # Run the script to disable nerd fonts before launching Yazi.
      - desktop-file-edit assets/yazi.desktop --set-key=Exec --set-value="yazi-wrapper.sh
        %u"
      - install -Dm00644 theme-no-nerd-fonts.toml ${FLATPAK_DEST}/share/theme-no-nerd-fonts.toml
      - install -Dm00744 yazi-wrapper.sh ${FLATPAK_DEST}/bin/yazi-wrapper.sh
      - install -Dm00644 assets/yazi.desktop ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.desktop
      - install -Dm00644 flatpak.xml ${FLATPAK_DEST}/share/metainfo/${FLATPAK_ID}.appdata.xml
    sources:
      - type: git
        url: https://github.com/sxyazi/yazi.git
        tag: v25.12.29
        commit: f31147d246b8930dd82f2c45b24a230896d3fda4
        x-checker-data:
          type: anitya
          project-id: 370571
          stable-only: true
          tag-template: v$version
      - type: file
        url: https://raw.githubusercontent.com/yazi-rs/assets/aad3e39fab6567bfed83e2725eca62ad11bd01e0/flatpak.xml
        sha256: f16a24555eb6ed22816d4b6eea0e6044db2dcdbdeff3c90a6bb336313cf2711c
      - cargo-sources-yazi.json
      - type: file
        path: theme-no-nerd-fonts.toml
      - type: file
        path: yazi-wrapper.sh
